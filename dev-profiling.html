<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Developer and Internals &raquo; System Profiling | OpenVINS</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,600,600i%7CSource+Code+Pro:400,400i,600&amp;subset=latin-ext" />
  <link rel="stylesheet" href="m-udel+documentation.compiled.css" />
  <link rel="stylesheet" href="custom.css" />
  <link rel="icon" href="favicon-light.png" type="image/png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2f73a3" />
</head>
<body>
<header><nav id="navigation">
  <div class="m-container">
    <div class="m-row">
      <a href="index.html" id="m-navbar-brand" class="m-col-t-8 m-col-m-none m-left-m">OpenVINS</a>
      <div class="m-col-t-4 m-hide-m m-text-right m-nopadr">
        <a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
          <path id="m-doc-search-icon-path" d="m6 0c-3.31 0-6 2.69-6 6 0 3.31 2.69 6 6 6 1.49 0 2.85-0.541 3.89-1.44-0.0164 0.338 0.147 0.759 0.5 1.15l3.22 3.79c0.552 0.614 1.45 0.665 2 0.115 0.55-0.55 0.499-1.45-0.115-2l-3.79-3.22c-0.392-0.353-0.812-0.515-1.15-0.5 0.895-1.05 1.44-2.41 1.44-3.89 0-3.31-2.69-6-6-6zm0 1.56a4.44 4.44 0 0 1 4.44 4.44 4.44 4.44 0 0 1-4.44 4.44 4.44 4.44 0 0 1-4.44-4.44 4.44 4.44 0 0 1 4.44-4.44z"/>
        </svg></a>
        <a id="m-navbar-show" href="#navigation" title="Show navigation"></a>
        <a id="m-navbar-hide" href="#" title="Hide navigation"></a>
      </div>
      <div id="m-navbar-collapse" class="m-col-t-12 m-show-m m-col-m-none m-right-m">
        <div class="m-row">
          <ol class="m-col-t-6 m-col-m-none">
            <li><a href="pages.html">Pages</a></li>
            <li><a href="annotated.html">Classes</a></li>
            <li><a href="namespaceov__core.html">ov_core</a></li>
            <li><a href="namespaceov__type.html">ov_type</a></li>
            <li><a href="namespaceov__msckf.html">ov_msckf</a></li>
            <li><a href="namespaceov__init.html">ov_init</a></li>
            <li><a href="namespaceov__eval.html">ov_eval</a></li>
          </ol>
          <ol class="m-col-t-6 m-col-m-none" start="8">
            <li><a href="https://github.com/rpng/open_vins/">GitHub</a></li>
            <li class="m-show-m"><a href="#search" class="m-doc-search-icon" title="Search" onclick="return showSearch()"><svg style="height: 0.9rem;" viewBox="0 0 16 16">
              <use href="#m-doc-search-icon-path" />
            </svg></a></li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</nav></header>
<main><article>
  <div class="m-container m-container-inflatable">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <h1>
          <span class="m-breadcrumb"><a href="dev-welcome.html">Developer and Internals</a> &raquo;</span>
          System Profiling
        </h1>
        <div class="m-block m-default">
          <h3>Contents</h3>
          <ul>
            <li><a href="#dev-profiling-compute">Profiling Processing Time</a></li>
            <li><a href="#dev-profiling-leaks">Memory Leaks</a></li>
            <li><a href="#dev-profiling-compiler">Compiler Profiling</a></li>
          </ul>
        </div>
<section id="dev-profiling-compute"><h2><a href="#dev-profiling-compute">Profiling Processing Time</a></h2><p>One way (besides inserting timing statements into the code) is to leverage a profiler such as <a href="https://www.valgrind.org/">valgrind</a>. This tool allows for recording of the call stack of the system. To use this with a ROS node, we can do the following (based on <a href="http://wiki.ros.org/roslaunch/Tutorials/Roslaunch%20Nodes%20in%20Valgrind%20or%20GDB">this</a> guide):</p><ul><li>Edit <code>roslaunch <a href="namespaceov__msckf.html" class="m-doc">ov_<wbr />msckf</a> pgeneva_serial_eth.launch</code> launch file</li><li>Append <code>launch-prefix=&quot;valgrind --tool=callgrind --callgrind-out-file=/tmp/callgrind.txt&quot;</code> to your ROS node. This will cause the node to run with valgrind.</li><li>Change the bag length to be only 10 or so seconds (since profiling is slow)</li></ul><pre class="m-console"><span class="go">sudo apt install valgrind</span>
<span class="go">roslaunch ov_msckf pgeneva_serial_eth.launch</span></pre><p>After running the profiling program we will want to visualize it. There are some good tools for that, specifically we are using <a href="https://github.com/jrfonseca/gprof2dot">gprof2dot</a> and <a href="https://github.com/jrfonseca/xdot.py">xdot.py</a>. First we will post-process it into a xdot graph format and then visualize it for inspection.</p><img class="m-image" src="example_callgrind.png" alt="Image" style="width: 80%;" /><pre class="m-console"><span class="go">// install viz programs</span>
<span class="go">apt-get install python3 graphviz</span>
<span class="go">apt-get install gir1.2-gtk-3.0 python3-gi python3-gi-cairo graphviz</span>
<span class="go">pip install gprof2dot xdot</span>
<span class="go">// actually process and then viz call file</span>
<span class="go">gprof2dot --format callgrind --strip /tmp/callgrind.txt --output /tmp/callgrind.xdot</span>
<span class="go">xdot /tmp/callgrind.xdot</span></pre></section><section id="dev-profiling-leaks"><h2><a href="#dev-profiling-leaks">Memory Leaks</a></h2><p>One can leverage a profiler such as <a href="https://www.valgrind.org/">valgrind</a> to perform memory leak check of the codebase. Ensure you have installed the <code>valgrind</code> package (see above). We can change the node launch file as follows:</p><ul><li>Edit <code>roslaunch <a href="namespaceov__msckf.html" class="m-doc">ov_<wbr />msckf</a> pgeneva_serial_eth.launch</code> launch file</li><li>Append <code>launch-prefix=&quot;valgrind --tool=memcheck --leak-check=yes&quot;</code> to your ROS node. This will cause the node to run with valgrind.</li><li>Change the bag length to be only 10 or so seconds (since profiling is slow)</li></ul><p>This <a href="https://web.stanford.edu/class/archive/cs/cs107/cs107.1206/resources/valgrind.html">page</a> has some nice support material for FAQ. An example loss is shown below which was found by memcheck.</p><pre class="m-code">==5512== 1,578,860 (24 direct, 1,578,836 indirect) bytes in 1 blocks are definitely lost in loss record 6,585 of 6,589
==5512==    at 0x4C3017F: operator new(unsigned long) (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
....
==5512==    by 0x543F868: operator[] (unordered_map.h:973)
==5512==    by 0x543F868: ov_core::TrackKLT::feed_stereo(double, cv::Mat&amp;, cv::Mat&amp;, unsigned long, unsigned long) (TrackKLT.cpp:165)
==5512==    by 0x4EF8C52: ov_msckf::VioManager::feed_measurement_stereo(double, cv::Mat&amp;, cv::Mat&amp;, unsigned long, unsigned long) (VioManager.cpp:245)
==5512==    by 0x1238A9: main (ros_serial_msckf.cpp:247)</pre></section><section id="dev-profiling-compiler"><h2><a href="#dev-profiling-compiler">Compiler Profiling</a></h2><p>Here is a small guide on how to perform compiler profiling for building of the codebase. This should be used to try to minimize compile times which in general hurt developer productivity. It is recommended to read the following pages which this is a condenced form of:</p><ul><li><a href="https://aras-p.info/blog/2019/01/16/time-trace-timeline-flame-chart-profiler-for-Clang/">https:/<wbr />/<wbr />aras-p.info/<wbr />blog/<wbr />2019/<wbr />01/<wbr />16/<wbr />time-trace-timeline-flame-chart-profiler-for-Clang/<wbr /></a></li><li><a href="https://aras-p.info/blog/2019/09/28/Clang-Build-Analyzer/">https:/<wbr />/<wbr />aras-p.info/<wbr />blog/<wbr />2019/<wbr />09/<wbr />28/<wbr />Clang-Build-Analyzer/<wbr /></a></li></ul><p>First we need to ensure we have a compiler that can profile the build time. Clang greater then 9 should work, but we have tested only with 11. We can get the <a href="https://apt.llvm.org/">latest Clang</a> by using the follow auto-install script:</p><pre class="m-console"><span class="go">sudo bash -c &quot;$(wget -O - https://apt.llvm.org/llvm.sh)&quot;</span>
<span class="go">export CC=/usr/bin/clang-11</span>
<span class="go">export CXX=/usr/bin/clang++-11</span></pre><p>We then need to clone the analyzer repository, which allows for summary generation.</p><pre class="m-console"><span class="go">git clone https://github.com/aras-p/ClangBuildAnalyzer</span>
<span class="go">cd ClangBuildAnalyzer</span>
<span class="go">cmake . &amp;&amp; make</span></pre><p>We can finally build our ROS package and time how long it takes. Note that we are using <a href="https://catkin-tools.readthedocs.io/en/latest/">catkin tools</a> to build here. The prefix <em>CBA</em> means to run the command in the ClangBuildAnalyzer repository clone folder. While the prefix <em>WS</em> means run in the root of your ROS workspace.</p><pre class="m-console"><span class="go">(WS) cd ~/workspace/</span>
<span class="go">(WS) catkin clean -y &amp;&amp; mkdir build</span>
<span class="go">(CBA) ./ClangBuildAnalyzer --start ~/workspace/build/</span>
<span class="go">(WS) export CC=/usr/bin/clang-11 &amp;&amp; export CXX=/usr/bin/clang++-11</span>
<span class="go">(WS) catkin build ov_msckf -DCMAKE_CXX_FLAGS=&quot;-ftime-trace&quot;</span>
<span class="go">(CBA) ./ClangBuildAnalyzer --stop ~/workspace/build/ capture_file.bin</span>
<span class="go">(CBA) ./ClangBuildAnalyzer --analyze capture_file.bin &gt; timing_results.txt</span></pre><p>The <code>time-trace</code> flag should generate a bunch of .json files in your build folder. These can be opened in your chrome browser <code>chrome://tracing</code> for viewing. In general the ClangBuildAnalyzer is more useful for finding what files take long. An example output of what is generated in the timing_results.txt file is:</p><pre class="m-code">Analyzing build trace from &#39;capture_file.bin&#39;...
     Time summary:
Compilation (86 times):
  Parsing (frontend):          313.9 s
  Codegen &amp; opts (backend):    222.9 s

     Files that took longest to parse (compiler frontend):
 13139 ms: /build//ov_msckf/CMakeFiles/ov_msckf_lib.dir/src/update/UpdaterSLAM.cpp.o
 12843 ms: /build//ov_msckf/CMakeFiles/run_serial_msckf.dir/src/ros_serial_msckf.cpp.o
 ...
 
     Functions that took longest to compile:
  1639 ms: main (/src/open_vins/ov_eval/src/error_comparison.cpp)
  1337 ms: ov_core::BsplineSE3::get_acceleration(double, Eigen::Matrix&lt;double, ... (/src/open_vins/ov_core/src/sim/BsplineSE3.cpp)
  1156 ms: ov_eval::ResultSimulation::plot_state(bool, double) (/src/open_vins/ov_eval/src/calc/ResultSimulation.cpp)
  ...

     Expensive headers: 
 27505 ms: /src/open_vins/ov_core/src/track/TrackBase.h (included 12 times, avg 2292 ms), included via:
   TrackKLT.cpp.o TrackKLT.h  (4372 ms)
   TrackBase.cpp.o  (4297 ms)
   TrackSIM.cpp.o TrackSIM.h  (4252 ms)
   ...</pre><p>Some key methods to reduce compile times are as follows:</p><ul><li>Only include headers that are required for your class</li><li>Don&#x27;t include headers in your header files <code>.h</code> that are only required in your <code>.cpp</code> source files.</li><li>Consider <a href="https://www.wikiwand.com/en/Forward_declaration">forward declarations</a> of methods and types</li><li>Ensure you are using an include guard in your headers</li></ul></section>
      </div>
    </div>
  </div>
</article></main>
<div class="m-doc-search" id="search">
  <a href="#!" onclick="return hideSearch()"></a>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-m-8 m-push-m-2">
        <div class="m-doc-search-header m-text m-small">
          <div><span class="m-label m-default">Tab</span> / <span class="m-label m-default">T</span> to search, <span class="m-label m-default">Esc</span> to close</div>
          <div id="search-symbolcount">&hellip;</div>
        </div>
        <div class="m-doc-search-content">
          <form>
            <input type="search" name="q" id="search-input" placeholder="Loading &hellip;" disabled="disabled" autofocus="autofocus" autocomplete="off" spellcheck="false" />
          </form>
          <noscript class="m-text m-danger m-text-center">Unlike everything else in the docs, the search functionality <em>requires</em> JavaScript.</noscript>
          <div id="search-help" class="m-text m-dim m-text-center">
            <p class="m-noindent">Search for symbols, directories, files, pages or
            modules. You can omit any prefix from the symbol or file path; adding a
            <code>:</code> or <code>/</code> suffix lists all members of given symbol or
            directory.</p>
            <p class="m-noindent">Use <span class="m-label m-dim">&darr;</span>
            / <span class="m-label m-dim">&uarr;</span> to navigate through the list,
            <span class="m-label m-dim">Enter</span> to go.
            <span class="m-label m-dim">Tab</span> autocompletes common prefix, you can
            copy a link to the result using <span class="m-label m-dim">⌘</span>
            <span class="m-label m-dim">L</span> while <span class="m-label m-dim">⌘</span>
            <span class="m-label m-dim">M</span> produces a Markdown link.</p>
          </div>
          <div id="search-notfound" class="m-text m-warning m-text-center">Sorry, nothing was found.</div>
          <ul id="search-results"></ul>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="search-v1.js"></script>
<script src="searchdata-v1.js" async="async"></script>
<footer><nav>
  <div class="m-container">
    <div class="m-row">
      <div class="m-col-l-10 m-push-l-1">
        <p>Generated by <a href="https://doxygen.org/">Doxygen</a> 1.8.19 and <a href="https://mcss.mosra.cz/">m.css</a>.</p>
      </div>
    </div>
  </div>
</nav></footer>
</body>
</html>
